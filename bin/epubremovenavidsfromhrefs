#!/usr/bin/env python
"""
This file is meant to be used on the toc and nav files for an epub because some ereaders do not play well with the ids
that are sometimes present at the end of a content's source. In order to prevent this issue, ids will be removed unless
there are 2 pieces of content that refer to the same file in which case the the epub may need a file restructure to fix
the issue.
"""

import re
import sys


def remove_id_if_exists_and_check_if_file_already_in_list(match):
    global ignore_file
    global existing_files

    match1 = match.group(1)
    match2 = match.group(2)
    match3 = match.group(3)

    if ignore_file is True:
        return "{0}{1}{2}".format(match1, match2, match3)

    hashtag_index = match2.find("#")
    if hashtag_index != -1:
        match2 = match2[hashtag_index : len(match2)]

    if match2 in existing_files:
        ignore_file = True

    return "{0}{1}{2}".format(match1, match2, match3)


# <content src="titlepage.xhtml"/>
def remove_ids_from_hrefs(text):
    global ignore_file
    ignore_file = False

    global existing_files
    existing_files = {}

    updated_text = re.sub(
        r"(<content.* src=[\"'])([^\"']*)([\"'][^>\n]*>)",
        remove_id_if_exists_and_check_if_file_already_in_list,
        text,
    )

    if ignore_file is True:
        print(
            "The file has more than one reference to the same file. Consider restructuring the epub to fix up the TOC."
        )

        return text

    return updated_text


if __name__ == "__main__":
    if len(sys.argv) >= 2:
        with open(sys.argv[1], "r+") as f:
            text = f.read()
            text = remove_ids_from_hrefs(text)
            f.seek(0)
            f.write(text)
            f.truncate()
